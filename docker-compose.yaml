# ==============================================================================
# DIFY FOR PORTAINER - SIMPLIFIED NGINX
# Domain: dify.lucasnextgen.com
# Server: 8GB RAM, 4 CPU
# NO .env file needed - all values are hardcoded
# NGINX SIMPLIFIED - no custom volumes/entrypoint to avoid Portainer issues
# ==============================================================================

services:
  # ============================================================================
  # API SERVICE
  # ============================================================================
  api:
    image: langgenius/dify-api:1.9.2
    restart: always
    environment:
      # URLs
      CONSOLE_API_URL: https://dify.lucasnextgen.com
      CONSOLE_WEB_URL: https://dify.lucasnextgen.com
      SERVICE_API_URL: https://dify.lucasnextgen.com
      APP_API_URL: https://dify.lucasnextgen.com
      APP_WEB_URL: https://dify.lucasnextgen.com
      FILES_URL: https://dify.lucasnextgen.com
      INTERNAL_FILES_URL: http://api:5001

      # Common
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      PYTHONIOENCODING: utf-8

      # Logging
      LOG_LEVEL: INFO
      LOG_FILE: /app/logs/server.log
      LOG_FILE_MAX_SIZE: 20
      LOG_FILE_BACKUP_COUNT: 5
      LOG_DATEFORMAT: "%Y-%m-%d %H:%M:%S"
      LOG_TZ: UTC

      # Debug
      DEBUG: false
      FLASK_DEBUG: false
      ENABLE_REQUEST_LOGGING: False

      # Security
      SECRET_KEY: xuvSA8Mw2BGYSK7wyRJ8T28pkwXNvsA/24KVsjNg36bxTCginrlZSAbK
      INIT_PASSWORD: ""

      # Deployment
      DEPLOY_ENV: PRODUCTION
      CHECK_UPDATE_URL: https://updates.dify.ai
      OPENAI_API_BASE: https://api.openai.com/v1
      MIGRATION_ENABLED: true
      FILES_ACCESS_TIMEOUT: 300
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      REFRESH_TOKEN_EXPIRE_DAYS: 30
      APP_MAX_ACTIVE_REQUESTS: 0
      APP_MAX_EXECUTION_TIME: 1200

      # API Server Config
      MODE: api
      DIFY_BIND_ADDRESS: 0.0.0.0
      DIFY_PORT: 5001
      SERVER_WORKER_AMOUNT: 2
      SERVER_WORKER_CLASS: gevent
      SERVER_WORKER_CONNECTIONS: 10
      CELERY_WORKER_CLASS: ""
      GUNICORN_TIMEOUT: 360
      CELERY_WORKER_AMOUNT: 2
      CELERY_AUTO_SCALE: false

      # API Tools
      API_TOOL_DEFAULT_CONNECT_TIMEOUT: 10
      API_TOOL_DEFAULT_READ_TIMEOUT: 60

      # Datasources
      ENABLE_WEBSITE_JINAREADER: true
      ENABLE_WEBSITE_FIRECRAWL: true
      ENABLE_WEBSITE_WATERCRAWL: true
      NEXT_PUBLIC_ENABLE_SINGLE_DOLLAR_LATEX: false

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: d08b82088108d639dd2b2aadd9a12d87
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify
      SQLALCHEMY_POOL_SIZE: 30
      SQLALCHEMY_MAX_OVERFLOW: 10
      SQLALCHEMY_POOL_RECYCLE: 3600
      SQLALCHEMY_ECHO: false
      SQLALCHEMY_POOL_PRE_PING: false
      SQLALCHEMY_POOL_USE_LIFO: false
      SQLALCHEMY_POOL_TIMEOUT: 30

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_USERNAME: ""
      REDIS_PASSWORD: 5650b9a6aeaa9378bb085486da1431c9
      REDIS_USE_SSL: false
      REDIS_DB: 0
      REDIS_USE_SENTINEL: false
      REDIS_USE_CLUSTERS: false

      # Celery
      CELERY_BROKER_URL: redis://:5650b9a6aeaa9378bb085486da1431c9@redis:6379/1
      CELERY_BACKEND: redis
      BROKER_USE_SSL: false
      CELERY_USE_SENTINEL: false

      # CORS
      WEB_API_CORS_ALLOW_ORIGINS: "*"
      CONSOLE_CORS_ALLOW_ORIGINS: "*"
      COOKIE_DOMAIN: ""
      NEXT_PUBLIC_COOKIE_DOMAIN: ""

      # Storage
      STORAGE_TYPE: opendal
      OPENDAL_SCHEME: fs
      OPENDAL_FS_ROOT: storage

      # Vector Store
      VECTOR_STORE: weaviate
      VECTOR_INDEX_NAME_PREFIX: Vector_index
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: aZDe4vHUn4O5IDHEPbELAvPdwDa00tscWnMvFwVj3XwiLPgHd+pg9gJD

      # Sentry
      SENTRY_DSN: ""
      SENTRY_TRACES_SAMPLE_RATE: 1.0
      SENTRY_PROFILES_SAMPLE_RATE: 1.0

      # Plugins
      PLUGIN_REMOTE_INSTALL_HOST: plugin_daemon
      PLUGIN_REMOTE_INSTALL_PORT: 5003
      PLUGIN_MAX_PACKAGE_SIZE: 52428800
      INNER_API_KEY_FOR_PLUGIN: vpXGkgLM3IKVunebaO5J70AmN+/sW7Vh+BdkrOEzhGp7SJHgEqTA5XwE

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./docker/volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 768M

  # ============================================================================
  # WORKER SERVICE
  # ============================================================================
  worker:
    image: langgenius/dify-api:1.9.2
    restart: always
    environment:
      # URLs
      CONSOLE_API_URL: https://dify.lucasnextgen.com
      CONSOLE_WEB_URL: https://dify.lucasnextgen.com
      SERVICE_API_URL: https://dify.lucasnextgen.com
      APP_API_URL: https://dify.lucasnextgen.com
      APP_WEB_URL: https://dify.lucasnextgen.com
      FILES_URL: https://dify.lucasnextgen.com
      INTERNAL_FILES_URL: http://api:5001

      # Common
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      PYTHONIOENCODING: utf-8

      # Logging
      LOG_LEVEL: INFO
      LOG_FILE: /app/logs/server.log
      LOG_FILE_MAX_SIZE: 20
      LOG_FILE_BACKUP_COUNT: 5
      LOG_DATEFORMAT: "%Y-%m-%d %H:%M:%S"
      LOG_TZ: UTC

      # Debug
      DEBUG: false
      FLASK_DEBUG: false
      ENABLE_REQUEST_LOGGING: False

      # Security
      SECRET_KEY: xuvSA8Mw2BGYSK7wyRJ8T28pkwXNvsA/24KVsjNg36bxTCginrlZSAbK
      INIT_PASSWORD: ""

      # Deployment
      DEPLOY_ENV: PRODUCTION
      CHECK_UPDATE_URL: https://updates.dify.ai
      OPENAI_API_BASE: https://api.openai.com/v1
      MIGRATION_ENABLED: true
      FILES_ACCESS_TIMEOUT: 300
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      REFRESH_TOKEN_EXPIRE_DAYS: 30
      APP_MAX_ACTIVE_REQUESTS: 0
      APP_MAX_EXECUTION_TIME: 1200

      # Worker Config
      MODE: worker
      DIFY_BIND_ADDRESS: 0.0.0.0
      DIFY_PORT: 5001
      SERVER_WORKER_AMOUNT: 2
      SERVER_WORKER_CLASS: gevent
      SERVER_WORKER_CONNECTIONS: 10
      CELERY_WORKER_CLASS: ""
      GUNICORN_TIMEOUT: 360
      CELERY_WORKER_AMOUNT: 2
      CELERY_AUTO_SCALE: false

      # API Tools
      API_TOOL_DEFAULT_CONNECT_TIMEOUT: 10
      API_TOOL_DEFAULT_READ_TIMEOUT: 60

      # Datasources
      ENABLE_WEBSITE_JINAREADER: true
      ENABLE_WEBSITE_FIRECRAWL: true
      ENABLE_WEBSITE_WATERCRAWL: true
      NEXT_PUBLIC_ENABLE_SINGLE_DOLLAR_LATEX: false

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: d08b82088108d639dd2b2aadd9a12d87
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify
      SQLALCHEMY_POOL_SIZE: 30
      SQLALCHEMY_MAX_OVERFLOW: 10
      SQLALCHEMY_POOL_RECYCLE: 3600
      SQLALCHEMY_ECHO: false
      SQLALCHEMY_POOL_PRE_PING: false
      SQLALCHEMY_POOL_USE_LIFO: false
      SQLALCHEMY_POOL_TIMEOUT: 30

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_USERNAME: ""
      REDIS_PASSWORD: 5650b9a6aeaa9378bb085486da1431c9
      REDIS_USE_SSL: false
      REDIS_DB: 0
      REDIS_USE_SENTINEL: false
      REDIS_USE_CLUSTERS: false

      # Celery
      CELERY_BROKER_URL: redis://:5650b9a6aeaa9378bb085486da1431c9@redis:6379/1
      CELERY_BACKEND: redis
      BROKER_USE_SSL: false
      CELERY_USE_SENTINEL: false

      # CORS
      WEB_API_CORS_ALLOW_ORIGINS: "*"
      CONSOLE_CORS_ALLOW_ORIGINS: "*"
      COOKIE_DOMAIN: ""
      NEXT_PUBLIC_COOKIE_DOMAIN: ""

      # Storage
      STORAGE_TYPE: opendal
      OPENDAL_SCHEME: fs
      OPENDAL_FS_ROOT: storage

      # Vector Store
      VECTOR_STORE: weaviate
      VECTOR_INDEX_NAME_PREFIX: Vector_index
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: aZDe4vHUn4O5IDHEPbELAvPdwDa00tscWnMvFwVj3XwiLPgHd+pg9gJD

      # Sentry
      SENTRY_DSN: ""
      SENTRY_TRACES_SAMPLE_RATE: 1.0
      SENTRY_PROFILES_SAMPLE_RATE: 1.0

      # Plugins
      PLUGIN_MAX_PACKAGE_SIZE: 52428800
      INNER_API_KEY_FOR_PLUGIN: vpXGkgLM3IKVunebaO5J70AmN+/sW7Vh+BdkrOEzhGp7SJHgEqTA5XwE

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./docker/volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 768M

  # ============================================================================
  # WORKER BEAT SERVICE
  # ============================================================================
  worker_beat:
    image: langgenius/dify-api:1.9.2
    restart: always
    environment:
      # URLs
      CONSOLE_API_URL: https://dify.lucasnextgen.com
      CONSOLE_WEB_URL: https://dify.lucasnextgen.com
      SERVICE_API_URL: https://dify.lucasnextgen.com
      APP_API_URL: https://dify.lucasnextgen.com
      APP_WEB_URL: https://dify.lucasnextgen.com
      FILES_URL: https://dify.lucasnextgen.com
      INTERNAL_FILES_URL: http://api:5001

      # Common
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      PYTHONIOENCODING: utf-8

      # Logging
      LOG_LEVEL: INFO
      LOG_FILE: /app/logs/server.log
      LOG_FILE_MAX_SIZE: 20
      LOG_FILE_BACKUP_COUNT: 5
      LOG_DATEFORMAT: "%Y-%m-%d %H:%M:%S"
      LOG_TZ: UTC

      # Debug
      DEBUG: false
      FLASK_DEBUG: false

      # Security
      SECRET_KEY: xuvSA8Mw2BGYSK7wyRJ8T28pkwXNvsA/24KVsjNg36bxTCginrlZSAbK

      # Beat Config
      MODE: beat

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: d08b82088108d639dd2b2aadd9a12d87
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: 5650b9a6aeaa9378bb085486da1431c9
      REDIS_DB: 0

      # Celery
      CELERY_BROKER_URL: redis://:5650b9a6aeaa9378bb085486da1431c9@redis:6379/1
      CELERY_BACKEND: redis

      # Storage
      STORAGE_TYPE: opendal
      OPENDAL_SCHEME: fs
      OPENDAL_FS_ROOT: storage

      # Vector Store
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: aZDe4vHUn4O5IDHEPbELAvPdwDa00tscWnMvFwVj3XwiLPgHd+pg9gJD

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - ssrf_proxy_network
      - default
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================================================
  # WEB SERVICE (Next.js Frontend)
  # ============================================================================
  web:
    image: langgenius/dify-web:1.9.2
    restart: always
    environment:
      CONSOLE_API_URL: https://dify.lucasnextgen.com
      APP_API_URL: https://dify.lucasnextgen.com
      NEXT_PUBLIC_COOKIE_DOMAIN: ""
      SENTRY_DSN: ""
      NEXT_TELEMETRY_DISABLED: 0
      TEXT_GENERATION_TIMEOUT_MS: 60000
      CSP_WHITELIST: ""
      ALLOW_EMBED: false
      ALLOW_UNSAFE_DATA_SCHEME: false
      MARKETPLACE_API_URL: https://marketplace.dify.ai
      MARKETPLACE_URL: https://marketplace.dify.ai
      TOP_K_MAX_VALUE: ""
      INDEXING_MAX_SEGMENTATION_TOKENS_LENGTH: ""
      PM2_INSTANCES: 2
      LOOP_NODE_MAX_COUNT: 100
      MAX_TOOLS_NUM: 10
      MAX_PARALLEL_LIMIT: 10
      MAX_ITERATIONS_NUM: 99
      MAX_TREE_DEPTH: 50
      ENABLE_WEBSITE_JINAREADER: true
      ENABLE_WEBSITE_FIRECRAWL: true
      ENABLE_WEBSITE_WATERCRAWL: true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 384M

  # ============================================================================
  # DATABASE (PostgreSQL)
  # ============================================================================
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: d08b82088108d639dd2b2aadd9a12d87
      POSTGRES_DB: dify
      PGDATA: /var/lib/postgresql/data/pgdata
    command: >
      postgres -c 'max_connections=100'
               -c 'shared_buffers=512MB'
               -c 'work_mem=4MB'
               -c 'maintenance_work_mem=64MB'
               -c 'effective_cache_size=2GB'
               -c 'statement_timeout=0'
               -c 'idle_in_transaction_session_timeout=0'
    volumes:
      - ./docker/volumes/db/data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "db", "-U", "postgres", "-d", "dify"]
      interval: 1s
      timeout: 3s
      retries: 60
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 768M

  # ============================================================================
  # REDIS
  # ============================================================================
  redis:
    image: redis:6-alpine
    restart: always
    environment:
      REDISCLI_AUTH: 5650b9a6aeaa9378bb085486da1431c9
    volumes:
      - ./docker/volumes/redis/data:/data
    command: redis-server --requirepass 5650b9a6aeaa9378bb085486da1431c9 --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a 5650b9a6aeaa9378bb085486da1431c9 ping | grep -q PONG"]
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================================================
  # SANDBOX
  # ============================================================================
  sandbox:
    image: langgenius/dify-sandbox:0.2.12
    restart: always
    environment:
      API_KEY: TxeZVxRzjE3TzciTFh1sZD+VABrJHJNVaSEIQ6k+9NVkfevskGlqsdoe
      GIN_MODE: release
      WORKER_TIMEOUT: 15
      ENABLE_NETWORK: true
      HTTP_PROXY: http://ssrf_proxy:3128
      HTTPS_PROXY: http://ssrf_proxy:3128
      SANDBOX_PORT: 8194
      PIP_MIRROR_URL: ""
    volumes:
      - ./docker/volumes/sandbox/dependencies:/dependencies
      - ./docker/volumes/sandbox/conf:/conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]
    networks:
      - ssrf_proxy_network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================================================
  # PLUGIN DAEMON
  # ============================================================================
  plugin_daemon:
    image: langgenius/dify-plugin-daemon:0.3.3-local
    restart: always
    environment:
      # URLs
      CONSOLE_API_URL: https://dify.lucasnextgen.com
      CONSOLE_WEB_URL: https://dify.lucasnextgen.com
      SERVICE_API_URL: https://dify.lucasnextgen.com
      APP_API_URL: https://dify.lucasnextgen.com
      APP_WEB_URL: https://dify.lucasnextgen.com
      FILES_URL: https://dify.lucasnextgen.com
      INTERNAL_FILES_URL: http://api:5001

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: d08b82088108d639dd2b2aadd9a12d87
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify_plugin

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: 5650b9a6aeaa9378bb085486da1431c9

      # Storage
      STORAGE_TYPE: opendal
      OPENDAL_SCHEME: fs
      OPENDAL_FS_ROOT: storage

      # Vector Store
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: aZDe4vHUn4O5IDHEPbELAvPdwDa00tscWnMvFwVj3XwiLPgHd+pg9gJD

      # Plugin Daemon Config
      SERVER_PORT: 5002
      SERVER_KEY: MJT9C+ZmHraHMJi4gs2c71Oj8b3r44j2QGwQLHrSVmVdOBBU4hlLaU5t
      MAX_PLUGIN_PACKAGE_SIZE: 52428800
      PPROF_ENABLED: false
      DIFY_INNER_API_URL: http://api:5001
      DIFY_INNER_API_KEY: vpXGkgLM3IKVunebaO5J70AmN+/sW7Vh+BdkrOEzhGp7SJHgEqTA5XwE
      PLUGIN_REMOTE_INSTALLING_HOST: 0.0.0.0
      PLUGIN_REMOTE_INSTALLING_PORT: 5003
      PLUGIN_WORKING_PATH: /app/storage/cwd
      FORCE_VERIFYING_SIGNATURE: true
      PYTHON_ENV_INIT_TIMEOUT: 120
      PLUGIN_MAX_EXECUTION_TIMEOUT: 600
      PLUGIN_STDIO_BUFFER_SIZE: 1024
      PLUGIN_STDIO_MAX_BUFFER_SIZE: 5242880
      MARKETPLACE_ENABLED: true
      MARKETPLACE_API_URL: https://marketplace.dify.ai
      SENTRY_ENABLED: false
      SENTRY_DSN: ""
      STORAGE_LOCAL_ROOT: /app/storage
      INSTALLED_PATH: plugin
      PACKAGE_CACHE_PATH: plugin_packages
      MEDIA_CACHE_PATH: assets
      WORKING_PATH: /app/storage/cwd
      PIP_MIRROR_URL: ""

    depends_on:
      db:
        condition: service_healthy
    ports:
      - "5003:5003"
    volumes:
      - ./docker/volumes/plugin_daemon:/app/storage
    networks:
      - ssrf_proxy_network
      - default
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 384M

  # ============================================================================
  # SSRF PROXY - SIMPLIFIED WITHOUT CUSTOM VOLUMES
  # ============================================================================
  ssrf_proxy:
    image: ubuntu/squid:latest
    restart: always
    # Removed custom volumes and entrypoint - using default squid config
    environment:
      SQUID_HTTP_PORT: 3128
    networks:
      - ssrf_proxy_network
      - default
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================================================
  # NGINX - SIMPLIFIED WITHOUT CUSTOM VOLUMES/ENTRYPOINT
  # Using nginx:alpine with inline config via entrypoint
  # ============================================================================
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "8100:80"
    depends_on:
      - api
      - web
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /etc/nginx/conf.d/default.conf <<'EOF'
        upstream api_server {
            server api:5001;
            keepalive 32;
        }
        upstream web_server {
            server web:3000;
            keepalive 32;
        }
        server {
            listen 80;
            server_name _;
            client_max_body_size 100M;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            location /console/api {
                proxy_pass http://api_server;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
            }
            location /api {
                proxy_pass http://api_server;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
            }
            location /v1 {
                proxy_pass http://api_server;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
            }
            location /files {
                proxy_pass http://api_server;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
            }
            location / {
                proxy_pass http://web_server;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $$http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
            }
        }
        EOF
        exec nginx -g 'daemon off;'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================================================
  # WEAVIATE (Vector Database)
  # ============================================================================
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    profiles:
      - weaviate
    restart: always
    volumes:
      - ./docker/volumes/weaviate:/var/lib/weaviate
    environment:
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: false
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: node1
      AUTHENTICATION_APIKEY_ENABLED: true
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: aZDe4vHUn4O5IDHEPbELAvPdwDa00tscWnMvFwVj3XwiLPgHd+pg9gJD
      AUTHENTICATION_APIKEY_USERS: hello@dify.ai
      AUTHORIZATION_ADMINLIST_ENABLED: true
      AUTHORIZATION_ADMINLIST_USERS: hello@dify.ai
      LIMIT_RESOURCES: "true"
      GOMEMLIMIT: "1280MiB"
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 768M

networks:
  ssrf_proxy_network:
    driver: bridge
    internal: true
  default:
    driver: bridge
